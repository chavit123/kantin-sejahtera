<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Kantin Sejahtera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Press Start 2P', cursive;
      background-color: #111;
      color: #fff;
      image-rendering: pixelated;
      transition: background-color 0.3s, color 0.3s;
    }
    .card, .list-group-item, .btn {
      border: 3px solid #fff;
      border-radius: 0;
      background-color: #222;
      color: #fff;
      font-size: 10px;
      box-shadow: none;
    }
    .btn {
      background-color: #ffc107;
      color: #000;
      font-size: 10px;
      padding: 8px 12px;
      border: 2px solid #fff;
    }
    .btn:hover {
      background-color: #ff9800;
      color: #fff;
    }
    .list-group-item.bg-success {
      background-color: #28a745 !important;
      color: #fff !important;
    }
    footer {
      font-size: 10px;
      font-family: 'Press Start 2P', cursive;
    }
    .navbar {
  border-bottom: 3px solid #fff;
}
.navbar-brand, .navbar-nav .nav-link {
  font-family: 'Press Start 2P', cursive;
  font-size: 10px;
}
.navbar-dark .navbar-nav .nav-link {
  color: #fff;
}
.navbar-dark .navbar-nav .nav-link:hover {
  color: #ffc107;
}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <span class="nav-link">Selamat datang, <span id="userName"></span></span>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="#">Admin</a>
          </li>
          <li class="nav-item">
            <button class="nav-link btn" id="logout-btn">Logout</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <audio id="click-sound" src="https://raw.githubusercontent.com/jwilber/retro-sound-effects/master/audio/menu-3.wav"></audio>
  <div class="container mt-4">
    <h1 class="text-center mb-4">Kantin Sejahtera</h1>
    <!-- Form tambah pembeli -->
    <h3>Tambah Pembeli</h3>
    <div class="card p-4 mb-4">
      <div class="mb-3">
        <label for="newUsername" class="form-label">Username</label>
        <input type="text" class="form-control" id="newUsername" placeholder="Masukkan username">
      </div>
      <div class="mb-3">
        <label for="newPassword" class="form-label">Password</label>
        <input type="password" class="form-control" id="newPassword" placeholder="Masukkan password">
      </div>
      <button class="btn btn-primary" id="addUserBtn">Tambah Pembeli</button>
      <div id="addUserError" class="text-danger d-none mt-3"></div>
      <div id="addUserSuccess" class="text-success d-none mt-3"></div>
    </div>
    <!-- Konten daftar pesanan -->
    <h3>Daftar Pesanan</h3>
    <div id="admin-orders" class="list-group"></div>
    <div id="loading" class="text-center d-none mt-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Memuat...</span>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <h1 class="text-center mb-4">Kantin Sejahtera</h1>
    <h3>Daftar Pesanan</h3>
    <div id="admin-orders" class="list-group"></div>

    <div id="loading" class="text-center d-none mt-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Memuat...</span>
      </div>
    </div>
  </div>

  <footer class="bg-dark text-white text-center py-3 mt-5">
    <p>Â©2025 Kantin Sejahtera</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const clickSound = document.getElementById('click-sound');
    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.classList.contains('btn')) {
        clickSound.currentTime = 0;
        clickSound.play();
      }
    });

    const JSONBIN_URL = 'https://api.jsonbin.io/v3/b/68620a988960c979a5b43337';
    const JSONBIN_SECRET_KEY = '$2a$10$zTy9l1VFkMjbE88RFz8QW.vcNao25h6UCa0kd3YjS7QoJyJykJX/S';

    async function fetchWithTimeout(url, options, timeout = 10000) {
      return Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Permintaan ke API terlalu lama (timeout)')), timeout))
      ]);
    }

    async function updateAdminOrders() {
      const ordersDiv = document.getElementById('admin-orders');
      const loading = document.getElementById('loading');
      ordersDiv.innerHTML = '';
      loading.classList.remove('d-none');
      try {
        const response = await fetchWithTimeout(JSONBIN_URL, {
          headers: { 'X-Master-Key': JSONBIN_SECRET_KEY }
        });
        if (!response.ok) throw new Error('Gagal mengambil data pesanan');
        const data = await response.json();
        let orders = data.record.orders || [];
        if (orders.length === 0) {
          ordersDiv.innerHTML = '<p>Belum ada pesanan.</p>';
          return;
        }
        orders = orders.sort((a, b) => {
          if (a.status === 'menunggu' && b.status !== 'menunggu') return -1;
          if (a.status !== 'menunggu' && b.status === 'menunggu') return 1;
          return new Date(a.createdAt) - new Date(b.createdAt);
        });
        orders.forEach((order, index) => {
          let total = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
          const statusClass = order.status === 'siap' ? 'bg-success text-white' : '';
          ordersDiv.innerHTML += `
            <div class="list-group-item ${statusClass}">
              <h5>Pesanan #${index + 1} (${order.status})</h5>
              <p><strong>Pelanggan:</strong> ${order.customerName}</p>
              <p><strong>Dibuat:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
              <ul>
                ${order.items.map(item => `<li>${item.name} (x${item.quantity}) - Rp ${(item.price * item.quantity).toLocaleString()}</li>`).join('')}
              </ul>
              <p><strong>Total:</strong> Rp ${total.toLocaleString()}</p>
              <div class="mt-2">
                ${order.status !== 'siap' ? `<button class="btn btn-success btn-sm confirm-order" data-id="${order.id}">Konfirmasi Siap</button>` : ''}
                <button class="btn btn-danger btn-sm delete-order" data-id="${order.id}">Hapus</button>
              </div>
            </div>
          `;
        });

        document.querySelectorAll('.confirm-order').forEach(btn => {
          btn.addEventListener('click', async () => {
            const orderId = btn.dataset.id;
            try {
              const response = await fetchWithTimeout(JSONBIN_URL, {
                headers: { 'X-Master-Key': JSONBIN_SECRET_KEY }
              });
              const data = await response.json();
              const orders = data.record.orders || [];
              const order = orders.find(o => o.id === orderId);
              if (order) {
                order.status = 'siap';
                await fetchWithTimeout(JSONBIN_URL, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_SECRET_KEY
                  },
                  body: JSON.stringify({ orders })
                });
                updateAdminOrders();
              }
            } catch (error) {
              ordersDiv.innerHTML += `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
          });
        });

        document.querySelectorAll('.delete-order').forEach(btn => {
          btn.addEventListener('click', async () => {
            const orderId = btn.dataset.id;
            if (confirm('Apakah Anda yakin ingin menghapus pesanan ini?')) {
              try {
                const response = await fetchWithTimeout(JSONBIN_URL, {
                  headers: { 'X-Master-Key': JSONBIN_SECRET_KEY }
                });
                const data = await response.json();
                let orders = data.record.orders || [];
                orders = orders.filter(o => o.id !== orderId);
                await fetchWithTimeout(JSONBIN_URL, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_SECRET_KEY
                  },
                  body: JSON.stringify({ orders })
                });
                updateAdminOrders();
              } catch (error) {
                ordersDiv.innerHTML += `<div class="alert alert-danger">Error: ${error.message}</div>`;
              }
            }
          });
        });
      } catch (error) {
        ordersDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
      } finally {
        loading.classList.add('d-none');
      }
    }

// Cek login admin
document.addEventListener('DOMContentLoaded', () => {
  const user = JSON.parse(localStorage.getItem('loggedInUser'));
  if (!user || user.role !== 'admin') {
    window.location.href = 'login.html';
  }
  document.getElementById('userName').textContent = user.username;
});

// Logout
document.getElementById('logout-btn').addEventListener('click', () => {
  localStorage.removeItem('loggedInUser');
  window.location.href = 'login.html';
});

// Tambah pembeli
document.getElementById('addUserBtn').addEventListener('click', async () => {
  const username = document.getElementById('newUsername').value.trim();
  const password = document.getElementById('newPassword').value;
  const errorDiv = document.getElementById('addUserError');
  const successDiv = document.getElementById('addUserSuccess');

  if (!username || !password) {
    errorDiv.textContent = 'Username dan password harus diisi!';
    errorDiv.classList.remove('d-none');
    successDiv.classList.add('d-none');
    return;
  }

  try {
    const response = await fetchWithTimeout(JSONBIN_URL, {
      headers: { 'X-Master-Key': JSONBIN_SECRET_KEY }
    });
    if (!response.ok) throw new Error('Gagal mengambil data pengguna');
    const data = await response.json();
    let users = data.record.users || defaultUsers;

    if (users.find(u => u.username === username)) {
      errorDiv.textContent = 'Username sudah ada!';
      errorDiv.classList.remove('d-none');
      successDiv.classList.add('d-none');
      return;
    }

    users.push({ username, password, role: 'pembeli' });
    const updateResponse = await fetchWithTimeout(JSONBIN_URL, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': JSONBIN_SECRET_KEY
      },
      body: JSON.stringify({ ...data.record, users })
    });
    if (!updateResponse.ok) throw new Error('Gagal menyimpan pengguna');

    successDiv.textContent = 'Pembeli berhasil ditambahkan!';
    successDiv.classList.remove('d-none');
    errorDiv.classList.add('d-none');
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
  } catch (error) {
    errorDiv.textContent = `Error: ${error.message}`;
    errorDiv.classList.remove('d-none');
    successDiv.classList.add('d-none');
  }
});

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-theme');
      }
      updateAdminOrders();
    });
  </script>
</body>
</html>